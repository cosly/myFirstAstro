---
import Layout from '../../layouts/Layout.astro';
import { QuoteViewer } from '../../components/customer-view/QuoteViewer';
import { createDb } from '../../lib/db';
import { quotes, auditLog } from '../../lib/db/schema';
import { eq } from 'drizzle-orm';
import { generateId } from '../../lib/utils';
import { resolveLocale, t, formatDateLocale, getTranslations, localeNames, type Locale } from '@/i18n';

const { token } = Astro.params;

if (!token) {
  return Astro.redirect('/');
}

// Resolve locale
const locale = resolveLocale(
  Astro.url,
  Astro.request.headers.get('cookie'),
  Astro.request.headers.get('accept-language')
);

const translations = getTranslations(locale);

const db = createDb(Astro.locals.runtime.env.DB);

// Fetch quote with customer and blocks
const quote = await db.query.quotes.findFirst({
  where: eq(quotes.publicToken, token),
  with: {
    customer: true,
    blocks: {
      with: {
        lines: true,
      },
      orderBy: (blocks, { asc }) => [asc(blocks.position)],
    },
  },
});

if (!quote) {
  return new Response(null, {
    status: 404,
    statusText: 'Not Found',
  });
}

// Mark as viewed if first time
if (quote.status === 'sent' && !quote.viewedAt) {
  await db
    .update(quotes)
    .set({
      status: 'viewed',
      viewedAt: new Date(),
      updatedAt: new Date(),
    })
    .where(eq(quotes.id, quote.id));

  // Log the view
  await db.insert(auditLog).values({
    id: generateId(),
    entityType: 'quote',
    entityId: quote.id,
    action: 'viewed',
    userType: 'customer',
    userEmail: quote.customer?.email || undefined,
    ipAddress: Astro.request.headers.get('CF-Connecting-IP') || Astro.request.headers.get('X-Forwarded-For') || undefined,
    userAgent: Astro.request.headers.get('User-Agent') || undefined,
  });
}

// Transform data for component - sort lines by position
const quoteData = {
  id: quote.id,
  quoteNumber: quote.quoteNumber,
  title: quote.title,
  introText: quote.introText || '',
  footerText: quote.footerText || '',
  status: quote.status,
  validUntil: quote.validUntil ? new Date(quote.validUntil) : undefined,
  subtotal: Number(quote.subtotal) || 0,
  btwAmount: Number(quote.btwAmount) || 0,
  total: Number(quote.total) || 0,
  blocks: quote.blocks.map(block => ({
    id: block.id,
    blockType: block.blockType as 'text' | 'pricing_table' | 'pricing_plans' | 'image' | 'signature',
    title: block.title || '',
    description: block.description || '',
    isOptional: block.isOptional || false,
    isSelectedByCustomer: block.isSelectedByCustomer ?? true,
    position: block.position,
    lines: (block.lines || [])
      .sort((a, b) => a.position - b.position)
      .map(line => ({
        id: line.id,
        description: line.description,
        quantity: Number(line.quantity),
        unit: line.unit,
        unitPrice: Number(line.unitPrice),
        btwRate: Number(line.btwRate),
        isOptional: line.isOptional || false,
        isSelectedByCustomer: line.isSelectedByCustomer ?? true,
        position: line.position,
      })),
  })),
};

const customerData = quote.customer ? {
  companyName: quote.customer.companyName,
  contactName: quote.customer.contactName,
  email: quote.customer.email,
} : {
  companyName: locale === 'nl' ? 'Onbekend' : 'Unknown',
  contactName: locale === 'nl' ? 'Onbekend' : 'Unknown',
  email: '',
};

// Check quote status
const isExpired = quote.validUntil && new Date(quote.validUntil) < new Date();
const isAccepted = quote.status === 'accepted';
const isDeclined = quote.status === 'declined';

// Format dates
const signedDate = quote.signedAt ? formatDateLocale(quote.signedAt, locale, 'long') : (locale === 'nl' ? 'onbekende datum' : 'unknown date');
const expiredDate = quote.validUntil ? formatDateLocale(quote.validUntil, locale, 'long') : (locale === 'nl' ? 'onbekende datum' : 'unknown date');
const signerFunction = quote.signedByFunction ? ` (${quote.signedByFunction})` : '';
---

<Layout title={`${t('customerPortal.quoteFor', locale)} ${quote.quoteNumber}`} description={t('customerPortal.quoteFor', locale)}>
  <!-- Language Switcher -->
  <div class="fixed top-4 right-4 z-50">
    <select
      id="language-switcher"
      class="rounded-lg border bg-white px-3 py-1.5 text-sm shadow-sm"
    >
      {Object.entries(localeNames).map(([code, name]) => (
        <option value={code} selected={code === locale}>{name}</option>
      ))}
    </select>
  </div>

  {isAccepted ? (
    <div class="min-h-screen bg-gradient-to-b from-green-50 to-white py-8 px-4">
      <div class="mx-auto max-w-4xl">
        <div class="rounded-xl border border-green-200 bg-white p-8 text-center shadow-sm">
          <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-green-100">
            <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-green-900">{t('customerPortal.status.accepted.title', locale)}</h1>
          <p class="mt-2 text-green-700">
            {t('customerPortal.status.accepted.message', locale, {
              date: signedDate,
              name: quote.signedByName || (locale === 'nl' ? 'onbekend' : 'unknown'),
              function: signerFunction
            })}
          </p>
          <p class="mt-4 text-sm text-gray-600">
            {t('customerPortal.status.accepted.followUp', locale)}
          </p>
        </div>
      </div>
    </div>
  ) : isDeclined ? (
    <div class="min-h-screen bg-gradient-to-b from-red-50 to-white py-8 px-4">
      <div class="mx-auto max-w-4xl">
        <div class="rounded-xl border border-red-200 bg-white p-8 text-center shadow-sm">
          <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100">
            <svg class="h-8 w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-red-900">{t('customerPortal.status.declined.title', locale)}</h1>
          <p class="mt-2 text-red-700">
            {t('customerPortal.status.declined.message', locale)}
          </p>
        </div>
      </div>
    </div>
  ) : isExpired ? (
    <div class="min-h-screen bg-gradient-to-b from-amber-50 to-white py-8 px-4">
      <div class="mx-auto max-w-4xl">
        <div class="rounded-xl border border-amber-200 bg-white p-8 text-center shadow-sm">
          <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-amber-100">
            <svg class="h-8 w-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-amber-900">{t('customerPortal.status.expired.title', locale)}</h1>
          <p class="mt-2 text-amber-700">
            {t('customerPortal.status.expired.message', locale, { date: expiredDate })}
          </p>
          <p class="mt-4 text-sm text-gray-600">
            {t('customerPortal.status.expired.followUp', locale)}
          </p>
        </div>
      </div>
    </div>
  ) : (
    <div class="min-h-screen bg-gradient-to-b from-tesoro-50 to-white py-8 px-4">
      <QuoteViewer
        client:load
        quote={quoteData}
        customer={customerData}
        publicToken={token}
        locale={locale}
        translations={translations.customerPortal}
      />
    </div>
  )}
</Layout>

<script>
  const switcher = document.getElementById('language-switcher') as HTMLSelectElement;

  switcher?.addEventListener('change', async (e) => {
    const locale = (e.target as HTMLSelectElement).value;

    try {
      await fetch('/api/locale', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ locale }),
      });

      // Reload page to apply new locale
      window.location.reload();
    } catch (error) {
      console.error('Failed to set locale:', error);
    }
  });
</script>
