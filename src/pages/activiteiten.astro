---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import { createDb, quotes } from '../lib/db';
import { desc } from 'drizzle-orm';
import { LiveActivities } from '../components/dashboard/LiveActivities';

let allQuotes: Array<{ id: string; quoteNumber: string; customerName?: string }> = [];

try {
  const db = createDb(Astro.locals.runtime.env.DB);

  // Get all quotes for the filter
  const quotesData = await db.query.quotes.findMany({
    with: { customer: true },
    orderBy: [desc(quotes.createdAt)],
    limit: 50,
  });

  allQuotes = quotesData.map(q => ({
    id: q.id,
    quoteNumber: q.quoteNumber,
    customerName: q.customer?.companyName,
  }));
} catch (error) {
  console.error('Failed to fetch activities:', error);
}
---

<DashboardLayout title="Activiteiten">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">Live Activiteit</h1>
        <p class="text-muted-foreground">Bekijk real-time wat klanten doen op hun offertes</p>
      </div>
    </div>

    <!-- Live Activities Component -->
    <LiveActivities quotes={allQuotes} client:load />
  </div>
</DashboardLayout>
