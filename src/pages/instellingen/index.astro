---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { createDb, appSettings, teamMembers as teamMembersTable } from '../../lib/db';
import { desc } from 'drizzle-orm';

const tabs = [
  { id: 'algemeen', label: 'Algemeen', icon: '‚öôÔ∏è' },
  { id: 'emails', label: 'Email Templates', icon: '‚úâÔ∏è' },
  { id: 'teksten', label: 'Tekst Templates', icon: 'üìù' },
  { id: 'team', label: 'Team', icon: 'üë•' },
  { id: 'integraties', label: 'Integraties', icon: 'üîó' },
];

const textTemplateTypes = [
  { id: 'intro', name: 'Introductie', description: 'Standaard introductietekst voor offertes' },
  { id: 'footer', name: 'Afsluiting', description: 'Standaard afsluittekst voor offertes' },
  { id: 'terms', name: 'Voorwaarden', description: 'Algemene voorwaarden en condities' },
];

const emailTemplateTypes = [
  { id: 'quote_sent', name: 'Offerte verstuurd', description: 'Wanneer een offerte naar de klant wordt verstuurd' },
  { id: 'quote_reminder', name: 'Herinnering', description: 'Automatische herinnering voor verlopen offerte' },
  { id: 'quote_accepted', name: 'Offerte geaccepteerd', description: 'Bevestiging wanneer klant accepteert' },
  { id: 'quote_declined', name: 'Offerte afgewezen', description: 'Notificatie wanneer klant afwijst' },
  { id: 'payment_received', name: 'Betaling ontvangen', description: 'Bevestiging van betaling' },
  { id: 'question_received', name: 'Vraag ontvangen', description: 'Wanneer klant een vraag stelt' },
];

// Fetch data from database
let settings: Record<string, unknown> = {};
let teamMembers: Array<{
  id: string;
  name: string;
  email: string;
  role: string;
  isActive: boolean;
}> = [];

try {
  const db = createDb(Astro.locals.runtime.env.DB);

  // Fetch settings
  const settingsRows = await db.select().from(appSettings);
  settingsRows.forEach(row => {
    try {
      settings[row.key] = typeof row.value === 'string' ? JSON.parse(row.value) : row.value;
    } catch {
      settings[row.key] = row.value;
    }
  });

  // Fetch team members
  const members = await db
    .select({
      id: teamMembersTable.id,
      name: teamMembersTable.name,
      email: teamMembersTable.email,
      role: teamMembersTable.role,
      isActive: teamMembersTable.isActive,
    })
    .from(teamMembersTable)
    .orderBy(desc(teamMembersTable.createdAt));

  teamMembers = members;
} catch (error) {
  console.error('Failed to fetch settings:', error);
}

// Default values
const companyName = (settings.company_name as string) || '';
const companyEmail = (settings.company_email as string) || '';
const companyPhone = (settings.company_phone as string) || '';
const companyAddress = (settings.company_address as string) || '';
const companyKvk = (settings.company_kvk as string) || '';
const companyBtw = (settings.company_btw as string) || '';
const quoteValidityDays = (settings.quote_validity_days as number) || 30;
const quoteNumberPrefix = (settings.quote_number_prefix as string) || '2024-';
const autoRemindersEnabled = (settings.auto_reminders_enabled as boolean) ?? true;
---

<DashboardLayout title="Instellingen">
  <div class="space-y-6">
    <!-- Header -->
    <div>
      <h1 class="text-2xl font-bold">Instellingen</h1>
      <p class="text-muted-foreground">Beheer uw applicatie instellingen</p>
    </div>

    <!-- Tabs -->
    <div class="flex border-b">
      {tabs.map((tab, index) => (
        <button
          data-tab={tab.id}
          class:list={[
            'flex items-center gap-2 px-4 py-3 text-sm font-medium border-b-2 -mb-px transition-colors',
            index === 0 ? 'border-tesoro-500 text-tesoro-600' : 'border-transparent text-muted-foreground hover:text-foreground'
          ]}
        >
          <span>{tab.icon}</span>
          {tab.label}
        </button>
      ))}
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Algemeen -->
      <div id="tab-algemeen" class="space-y-6">
        <div class="rounded-xl border bg-card p-6">
          <h3 class="font-semibold mb-4">Bedrijfsgegevens</h3>
          <form id="company-form" class="space-y-4 max-w-lg">
            <div class="space-y-2">
              <label class="text-sm font-medium">Bedrijfsnaam</label>
              <input type="text" name="company_name" value={companyName} class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm" />
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <div class="space-y-2">
                <label class="text-sm font-medium">Email</label>
                <input type="email" name="company_email" value={companyEmail} class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm" />
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium">Telefoon</label>
                <input type="tel" name="company_phone" value={companyPhone} class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm" />
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium">Adres</label>
              <input type="text" name="company_address" value={companyAddress} class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm" />
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <div class="space-y-2">
                <label class="text-sm font-medium">KVK nummer</label>
                <input type="text" name="company_kvk" value={companyKvk} class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm" />
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium">BTW nummer</label>
                <input type="text" name="company_btw" value={companyBtw} class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm" />
              </div>
            </div>
            <button type="submit" class="rounded-lg bg-tesoro-500 px-4 py-2 text-sm font-medium text-white hover:bg-tesoro-600">
              Opslaan
            </button>
            <span id="company-save-status" class="ml-2 text-sm text-green-600 hidden">Opgeslagen!</span>
          </form>
        </div>

        <div class="rounded-xl border bg-card p-6">
          <h3 class="font-semibold mb-4">Offerte instellingen</h3>
          <form id="quote-settings-form" class="space-y-4 max-w-lg">
            <div class="space-y-2">
              <label class="text-sm font-medium">Standaard geldigheid (dagen)</label>
              <input type="number" name="quote_validity_days" value={quoteValidityDays} class="flex h-10 w-32 rounded-lg border border-input bg-background px-3 py-2 text-sm" />
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium">Offerte nummerprefix</label>
              <input type="text" name="quote_number_prefix" value={quoteNumberPrefix} class="flex h-10 w-32 rounded-lg border border-input bg-background px-3 py-2 text-sm" />
            </div>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="auto_reminders_enabled" checked={autoRemindersEnabled} class="h-4 w-4 rounded border-gray-300 text-tesoro-500" />
              <span class="text-sm">Stuur automatische herinneringen</span>
            </label>
            <button type="submit" class="rounded-lg bg-tesoro-500 px-4 py-2 text-sm font-medium text-white hover:bg-tesoro-600">
              Opslaan
            </button>
            <span id="quote-save-status" class="ml-2 text-sm text-green-600 hidden">Opgeslagen!</span>
          </form>
        </div>

        <div class="rounded-xl border bg-card p-6">
          <h3 class="font-semibold mb-4">Taalvoorkeuren</h3>
          <div class="space-y-4 max-w-lg">
            <div class="space-y-2">
              <label class="text-sm font-medium">Persoonlijke taalvoorkeur</label>
              <p class="text-sm text-muted-foreground">
                Je kunt je persoonlijke dashboard taal instellen in je <a href="/profiel" class="text-tesoro-500 hover:underline">profiel</a>.
              </p>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium">Email taal voor klanten</label>
              <p class="text-sm text-muted-foreground">
                Emails worden verstuurd in de taal van de klant. Je kunt de taalvoorkeur per klant instellen bij het aanmaken of bewerken van een klant.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Emails -->
      <div id="tab-emails" class="hidden space-y-6">
        <div class="rounded-xl border bg-card overflow-hidden">
          <div class="border-b bg-muted/30 px-6 py-4">
            <h3 class="font-semibold">Email Templates</h3>
            <p class="text-sm text-muted-foreground">Pas de automatische emails aan</p>
          </div>
          <div class="divide-y">
            {emailTemplateTypes.map((template) => (
              <div class="flex items-center justify-between px-6 py-4 hover:bg-muted/30">
                <div>
                  <p class="font-medium">{template.name}</p>
                  <p class="text-sm text-muted-foreground">{template.description}</p>
                </div>
                <div class="flex gap-2">
                  <button
                    class="preview-template-btn rounded-lg border px-3 py-1.5 text-sm hover:bg-muted"
                    data-template-id={template.id}
                    data-template-name={template.name}
                  >
                    Preview
                  </button>
                  <a
                    href={`/instellingen/email-templates/${template.id}`}
                    class="rounded-lg border px-3 py-1.5 text-sm hover:bg-muted"
                  >
                    Bewerken
                  </a>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      <!-- Tekst Templates -->
      <div id="tab-teksten" class="hidden space-y-6">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Tekst Templates</h3>
            <p class="text-sm text-muted-foreground">Beheer standaard teksten voor offertes</p>
          </div>
          <button id="add-text-template-btn" class="inline-flex items-center gap-2 rounded-lg bg-tesoro-500 px-4 py-2 text-sm font-medium text-white hover:bg-tesoro-600">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Nieuwe template
          </button>
        </div>

        <!-- Template Categories -->
        {textTemplateTypes.map((type) => (
          <div class="rounded-xl border bg-card overflow-hidden" data-template-category={type.id}>
            <div class="border-b bg-muted/30 px-6 py-4 flex items-center justify-between">
              <div>
                <h4 class="font-semibold">{type.name}</h4>
                <p class="text-sm text-muted-foreground">{type.description}</p>
              </div>
              <button
                class="add-category-template-btn rounded-lg border px-3 py-1.5 text-sm hover:bg-muted"
                data-category={type.id}
                data-category-name={type.name}
              >
                + Toevoegen
              </button>
            </div>
            <div class="divide-y template-list" data-type={type.id}>
              <div class="p-6 text-center text-muted-foreground text-sm">
                <p>Laden...</p>
              </div>
            </div>
          </div>
        ))}
      </div>

      <!-- Team -->
      <div id="tab-team" class="hidden space-y-6">
        <div class="flex justify-end">
          <button id="add-member-btn" class="inline-flex items-center gap-2 rounded-lg bg-tesoro-500 px-4 py-2 text-sm font-medium text-white hover:bg-tesoro-600">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Teamlid toevoegen
          </button>
        </div>
        <div class="rounded-xl border bg-card overflow-hidden">
          {teamMembers.length === 0 ? (
            <div class="p-12 text-center">
              <svg class="mx-auto h-12 w-12 text-muted-foreground/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <h3 class="mt-4 text-lg font-medium">Geen teamleden</h3>
              <p class="mt-2 text-sm text-muted-foreground">Voeg je eerste teamlid toe om te beginnen.</p>
            </div>
          ) : (
            <table class="w-full">
              <thead class="border-b bg-muted/50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Naam</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Email</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Rol</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Status</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase">Acties</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                {teamMembers.map((member) => (
                  <tr class="hover:bg-muted/30">
                    <td class="px-6 py-4 font-medium">{member.name}</td>
                    <td class="px-6 py-4 text-sm">{member.email}</td>
                    <td class="px-6 py-4">
                      <span class:list={[
                        'inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium',
                        member.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'
                      ]}>
                        {member.role === 'admin' ? 'Beheerder' : 'Lid'}
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <span class:list={[
                        'inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs font-medium',
                        member.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                      ]}>
                        <span class:list={['h-1.5 w-1.5 rounded-full', member.isActive ? 'bg-green-500' : 'bg-gray-400']}></span>
                        {member.isActive ? 'Actief' : 'Inactief'}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <div class="flex items-center justify-end gap-1">
                        <button
                          class="edit-member-btn p-1.5 text-muted-foreground hover:text-foreground rounded-lg hover:bg-muted"
                          data-member-id={member.id}
                          data-member-name={member.name}
                          data-member-email={member.email}
                          data-member-role={member.role}
                          data-member-active={member.isActive ? 'true' : 'false'}
                        >
                          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                          </svg>
                        </button>
                        <button
                          class="delete-member-btn p-1.5 text-muted-foreground hover:text-red-500 rounded-lg hover:bg-muted"
                          data-member-id={member.id}
                          data-member-name={member.name}
                        >
                          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      </div>

      <!-- Integraties -->
      <div id="tab-integraties" class="hidden space-y-6">
        <div class="rounded-xl border bg-card p-6">
          <h3 class="font-semibold mb-4">API Keys</h3>
          <p class="text-sm text-muted-foreground mb-6">Configureer de API keys voor externe diensten. De keys worden veilig opgeslagen en zijn niet zichtbaar na opslaan.</p>

          <div class="space-y-6">
            <!-- Resend -->
            <div class="border rounded-lg p-4" data-api-key="resend">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100">
                    <span class="text-xl">‚úâÔ∏è</span>
                  </div>
                  <div>
                    <h4 class="font-medium">Resend</h4>
                    <p class="text-xs text-muted-foreground">Email verzending</p>
                  </div>
                </div>
                <span class="api-key-status rounded-full px-2.5 py-0.5 text-xs font-medium">Laden...</span>
              </div>
              <div class="flex gap-2">
                <input type="password" class="api-key-input flex-1 h-9 rounded-lg border border-input bg-background px-3 text-sm" placeholder="re_xxxxxxxx..." />
                <button class="api-key-save rounded-lg bg-tesoro-500 px-3 py-1.5 text-sm font-medium text-white hover:bg-tesoro-600">Opslaan</button>
                <button class="api-key-delete hidden rounded-lg border border-red-300 px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50">Verwijderen</button>
              </div>
            </div>

            <!-- Stripe Secret Key -->
            <div class="border rounded-lg p-4" data-api-key="stripe">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-[#635bff]/10">
                    <span class="text-xl">üí≥</span>
                  </div>
                  <div>
                    <h4 class="font-medium">Stripe Secret Key</h4>
                    <p class="text-xs text-muted-foreground">Betalingen verwerken (server-side)</p>
                  </div>
                </div>
                <span class="api-key-status rounded-full px-2.5 py-0.5 text-xs font-medium">Laden...</span>
              </div>
              <div class="flex gap-2">
                <input type="password" class="api-key-input flex-1 h-9 rounded-lg border border-input bg-background px-3 text-sm" placeholder="sk_live_xxxxxxxx..." />
                <button class="api-key-save rounded-lg bg-tesoro-500 px-3 py-1.5 text-sm font-medium text-white hover:bg-tesoro-600">Opslaan</button>
                <button class="api-key-delete hidden rounded-lg border border-red-300 px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50">Verwijderen</button>
              </div>
            </div>

            <!-- Stripe Publishable Key -->
            <div class="border rounded-lg p-4" data-api-key="stripe_publishable">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-[#635bff]/10">
                    <span class="text-xl">üí≥</span>
                  </div>
                  <div>
                    <h4 class="font-medium">Stripe Publishable Key</h4>
                    <p class="text-xs text-muted-foreground">Betalingen verwerken (client-side)</p>
                  </div>
                </div>
                <span class="api-key-status rounded-full px-2.5 py-0.5 text-xs font-medium">Laden...</span>
              </div>
              <div class="flex gap-2">
                <input type="password" class="api-key-input flex-1 h-9 rounded-lg border border-input bg-background px-3 text-sm" placeholder="pk_live_xxxxxxxx..." />
                <button class="api-key-save rounded-lg bg-tesoro-500 px-3 py-1.5 text-sm font-medium text-white hover:bg-tesoro-600">Opslaan</button>
                <button class="api-key-delete hidden rounded-lg border border-red-300 px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50">Verwijderen</button>
              </div>
            </div>

            <!-- Anthropic (Claude) -->
            <div class="border rounded-lg p-4" data-api-key="anthropic">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-orange-100">
                    <span class="text-xl">ü§ñ</span>
                  </div>
                  <div>
                    <h4 class="font-medium">Anthropic (Claude)</h4>
                    <p class="text-xs text-muted-foreground">AI tekst assistentie</p>
                  </div>
                </div>
                <span class="api-key-status rounded-full px-2.5 py-0.5 text-xs font-medium">Laden...</span>
              </div>
              <div class="flex gap-2">
                <input type="password" class="api-key-input flex-1 h-9 rounded-lg border border-input bg-background px-3 text-sm" placeholder="sk-ant-xxxxxxxx..." />
                <button class="api-key-save rounded-lg bg-tesoro-500 px-3 py-1.5 text-sm font-medium text-white hover:bg-tesoro-600">Opslaan</button>
                <button class="api-key-delete hidden rounded-lg border border-red-300 px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50">Verwijderen</button>
              </div>
            </div>

            <!-- OpenAI (GPT) -->
            <div class="border rounded-lg p-4" data-api-key="openai">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-100">
                    <span class="text-xl">üß†</span>
                  </div>
                  <div>
                    <h4 class="font-medium">OpenAI (GPT)</h4>
                    <p class="text-xs text-muted-foreground">AI tekst assistentie</p>
                  </div>
                </div>
                <span class="api-key-status rounded-full px-2.5 py-0.5 text-xs font-medium">Laden...</span>
              </div>
              <div class="flex gap-2">
                <input type="password" class="api-key-input flex-1 h-9 rounded-lg border border-input bg-background px-3 text-sm" placeholder="sk-xxxxxxxx..." />
                <button class="api-key-save rounded-lg bg-tesoro-500 px-3 py-1.5 text-sm font-medium text-white hover:bg-tesoro-600">Opslaan</button>
                <button class="api-key-delete hidden rounded-lg border border-red-300 px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50">Verwijderen</button>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Configuration with CF Gateway -->
        <div class="rounded-xl border bg-card p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-purple-100">
              <span class="text-xl">‚ú®</span>
            </div>
            <div>
              <h3 class="font-semibold">AI Configuratie</h3>
              <p class="text-sm text-muted-foreground">Configureer AI providers en optioneel Cloudflare AI Gateway</p>
            </div>
          </div>

          <div id="ai-gateway-settings">
            <div id="ai-gateway-loading" class="py-4 text-center text-muted-foreground text-sm">
              Laden...
            </div>

            <div id="ai-gateway-form" class="hidden space-y-6">
              <!-- Cloudflare AI Gateway (Optional) -->
              <div class="rounded-lg border bg-gradient-to-r from-orange-50 to-amber-50 p-4">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <svg class="h-5 w-5 text-orange-500" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M16.5088 16.8447C16.5088 16.8447 17.1377 15.5283 17.2554 15.2871C17.373 15.046 17.5495 14.8225 17.6849 14.6519C18.2903 14.1053 18.6373 13.3235 18.6373 12.4712C18.6373 11.0725 17.6318 9.88355 16.2921 9.67359C16.0156 9.62892 15.7097 9.62892 15.4273 9.66419C15.2391 7.95129 13.7935 6.61523 12.0394 6.61523C10.4232 6.61523 9.06537 7.75191 8.72193 9.26951C8.39609 9.14316 8.04089 9.07234 7.66801 9.07234C6.21888 9.07234 5.04224 10.249 5.04224 11.698C5.04224 11.9745 5.08691 12.2392 5.16126 12.4889C3.92286 12.8265 3 13.9632 3 15.2871C3 16.8682 4.27961 18.1478 5.86068 18.1478H10.9624V16.8447H5.86068C5.00132 16.8447 4.30313 16.1465 4.30313 15.2871C4.30313 14.4278 5.00132 13.7296 5.86068 13.7296C5.92798 13.7296 5.99528 13.7355 6.06257 13.7413C5.91623 13.2948 5.84186 12.8206 5.84186 12.3287C5.84186 10.7358 7.13328 9.44436 8.72606 9.44436C9.20579 9.44436 9.66258 9.56131 10.0678 9.77127C10.1939 8.29918 11.4147 7.1448 12.9605 7.1448C14.5063 7.1448 15.7273 8.29918 15.8533 9.77127C16.2586 9.56131 16.7154 9.44436 17.1951 9.44436C18.7879 9.44436 20.0793 10.7358 20.0793 12.3287C20.0793 12.8206 20.0049 13.2948 19.8586 13.7413C19.9259 13.7355 19.9932 13.7296 20.0605 13.7296C20.9199 13.7296 21.618 14.4278 21.618 15.2871C21.618 16.1465 20.9199 16.8447 20.0605 16.8447H16.5088Z"/>
                    </svg>
                    <span class="font-medium text-sm">Cloudflare AI Gateway</span>
                    <span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded">Optioneel</span>
                  </div>
                  <span id="ai-gateway-status" class="text-xs"></span>
                </div>
                <p class="text-xs text-muted-foreground mb-3">Routeer AI requests via Cloudflare voor caching, analytics en rate limiting.</p>
                <div class="grid gap-3 sm:grid-cols-2">
                  <div>
                    <label class="text-xs font-medium">Account ID</label>
                    <input type="text" id="ai-gateway-account-id"
                      class="mt-1 flex h-9 w-full rounded-lg border border-input bg-background px-3 text-sm"
                      placeholder="Cloudflare Account ID" />
                  </div>
                  <div>
                    <label class="text-xs font-medium">Gateway Name</label>
                    <input type="text" id="ai-gateway-name"
                      class="mt-1 flex h-9 w-full rounded-lg border border-input bg-background px-3 text-sm"
                      placeholder="my-ai-gateway" />
                  </div>
                </div>
              </div>

              <!-- Provider Selection -->
              <div>
                <label class="text-sm font-medium mb-3 block">Actieve Provider</label>
                <div class="grid gap-3 sm:grid-cols-2">
                  <!-- Anthropic Option -->
                  <label class="ai-provider-option relative flex cursor-pointer rounded-lg border p-4 hover:border-tesoro-300" data-provider="anthropic">
                    <input type="radio" name="ai_provider" value="anthropic" class="sr-only" />
                    <div class="flex items-start gap-3">
                      <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-orange-100 shrink-0">
                        <span class="text-xl">ü§ñ</span>
                      </div>
                      <div>
                        <p class="font-medium">Anthropic (Claude)</p>
                        <p class="text-xs text-muted-foreground">Claude Sonnet 4</p>
                        <span class="ai-provider-status mt-2 inline-block text-xs"></span>
                      </div>
                    </div>
                    <div class="ai-provider-check absolute right-3 top-3 hidden">
                      <svg class="h-5 w-5 text-tesoro-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                      </svg>
                    </div>
                  </label>

                  <!-- OpenAI Option -->
                  <label class="ai-provider-option relative flex cursor-pointer rounded-lg border p-4 hover:border-tesoro-300" data-provider="openai">
                    <input type="radio" name="ai_provider" value="openai" class="sr-only" />
                    <div class="flex items-start gap-3">
                      <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-100 shrink-0">
                        <span class="text-xl">üß†</span>
                      </div>
                      <div>
                        <p class="font-medium">OpenAI (GPT)</p>
                        <p class="text-xs text-muted-foreground">GPT-4o</p>
                        <span class="ai-provider-status mt-2 inline-block text-xs"></span>
                      </div>
                    </div>
                    <div class="ai-provider-check absolute right-3 top-3 hidden">
                      <svg class="h-5 w-5 text-tesoro-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="flex items-center justify-between pt-4 border-t">
                <button type="button" id="ai-test-btn"
                  class="flex items-center gap-2 rounded-lg border px-4 py-2 text-sm font-medium hover:bg-muted">
                  <span>üß™</span>
                  <span>Test Verbinding</span>
                </button>
                <button type="button" id="ai-save-btn"
                  class="rounded-lg bg-tesoro-500 px-4 py-2 text-sm font-medium text-white hover:bg-tesoro-600">
                  Opslaan
                </button>
              </div>

              <p id="ai-gateway-error" class="text-sm text-red-600 hidden"></p>
              <p id="ai-gateway-success" class="text-sm text-green-600 hidden"></p>
            </div>
          </div>
        </div>

        <!-- Discord Notifications -->
        <div class="rounded-xl border bg-card p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-[#5865F2]/10">
              <svg class="h-5 w-5 text-[#5865F2]" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold">Discord Notificaties</h3>
              <p class="text-sm text-muted-foreground">Ontvang meldingen in Discord bij belangrijke events</p>
            </div>
          </div>

          <div id="discord-settings" class="space-y-6">
            <!-- Loading state -->
            <div id="discord-loading" class="py-4 text-center text-muted-foreground text-sm">
              Laden...
            </div>

            <!-- Settings form (hidden until loaded) -->
            <div id="discord-form" class="hidden space-y-6">
              <!-- Enable toggle -->
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-medium">Discord notificaties inschakelen</p>
                  <p class="text-sm text-muted-foreground">Ontvang real-time meldingen in je Discord kanaal</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="discord-enabled" class="sr-only peer" />
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-tesoro-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-tesoro-500"></div>
                </label>
              </div>

              <!-- Webhook URL -->
              <div class="space-y-2">
                <label class="text-sm font-medium">Discord Webhook URL</label>
                <div class="flex gap-2">
                  <input
                    type="password"
                    id="discord-webhook-url"
                    class="flex-1 h-10 rounded-lg border border-input bg-background px-3 py-2 text-sm"
                    placeholder="https://discord.com/api/webhooks/..."
                  />
                  <button
                    id="discord-test-btn"
                    type="button"
                    class="rounded-lg border px-4 py-2 text-sm font-medium hover:bg-muted"
                  >
                    Testen
                  </button>
                </div>
                <p class="text-xs text-muted-foreground">
                  <a href="https://support.discord.com/hc/en-us/articles/228383668-Intro-to-Webhooks" target="_blank" rel="noopener" class="text-tesoro-500 hover:underline">
                    Hoe maak ik een webhook aan?
                  </a>
                </p>
              </div>

              <!-- Event toggles -->
              <div class="space-y-3">
                <p class="text-sm font-medium">Notificatie types</p>
                <div class="grid gap-3 sm:grid-cols-2">
                  <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-muted/30 cursor-pointer">
                    <input type="checkbox" id="discord-event-quote_request_received" class="discord-event mt-0.5 h-4 w-4 rounded border-gray-300 text-tesoro-500" />
                    <div>
                      <p class="text-sm font-medium">Nieuwe aanvraag</p>
                      <p class="text-xs text-muted-foreground">Wanneer een klant een offerte aanvraagt</p>
                    </div>
                  </label>
                  <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-muted/30 cursor-pointer">
                    <input type="checkbox" id="discord-event-quote_viewed" class="discord-event mt-0.5 h-4 w-4 rounded border-gray-300 text-tesoro-500" />
                    <div>
                      <p class="text-sm font-medium">Offerte bekeken</p>
                      <p class="text-xs text-muted-foreground">Wanneer een klant de offerte opent</p>
                    </div>
                  </label>
                  <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-muted/30 cursor-pointer">
                    <input type="checkbox" id="discord-event-quote_accepted" class="discord-event mt-0.5 h-4 w-4 rounded border-gray-300 text-tesoro-500" />
                    <div>
                      <p class="text-sm font-medium">Offerte geaccepteerd</p>
                      <p class="text-xs text-muted-foreground">Wanneer een klant accepteert en tekent</p>
                    </div>
                  </label>
                  <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-muted/30 cursor-pointer">
                    <input type="checkbox" id="discord-event-quote_declined" class="discord-event mt-0.5 h-4 w-4 rounded border-gray-300 text-tesoro-500" />
                    <div>
                      <p class="text-sm font-medium">Offerte afgewezen</p>
                      <p class="text-xs text-muted-foreground">Wanneer een klant de offerte afwijst</p>
                    </div>
                  </label>
                  <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-muted/30 cursor-pointer">
                    <input type="checkbox" id="discord-event-question_received" class="discord-event mt-0.5 h-4 w-4 rounded border-gray-300 text-tesoro-500" />
                    <div>
                      <p class="text-sm font-medium">Vraag ontvangen</p>
                      <p class="text-xs text-muted-foreground">Wanneer een klant een vraag stelt</p>
                    </div>
                  </label>
                  <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-muted/30 cursor-pointer">
                    <input type="checkbox" id="discord-event-payment_received" class="discord-event mt-0.5 h-4 w-4 rounded border-gray-300 text-tesoro-500" />
                    <div>
                      <p class="text-sm font-medium">Betaling ontvangen</p>
                      <p class="text-xs text-muted-foreground">Wanneer een betaling is voltooid</p>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Save button -->
              <div class="flex items-center gap-3">
                <button
                  id="discord-save-btn"
                  type="button"
                  class="rounded-lg bg-tesoro-500 px-4 py-2 text-sm font-medium text-white hover:bg-tesoro-600"
                >
                  Opslaan
                </button>
                <span id="discord-save-status" class="text-sm text-green-600 hidden">Opgeslagen!</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Team Member Modal -->
  <div id="member-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="member-modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
      <div class="relative w-full max-w-md rounded-2xl bg-card p-6 shadow-xl">
        <button id="close-member-modal" class="absolute right-4 top-4 p-1 text-muted-foreground hover:text-foreground">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>

        <h2 id="member-modal-title" class="text-xl font-semibold mb-6">Nieuw Teamlid</h2>

        <form id="member-form" class="space-y-4">
          <input type="hidden" id="member-id" name="id" />

          <div class="space-y-2">
            <label class="text-sm font-medium">Naam *</label>
            <input type="text" id="member-name" name="name" required class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm" />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium">Email *</label>
            <input type="email" id="member-email" name="email" required class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm" />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium">Wachtwoord <span id="password-required">*</span></label>
            <input type="password" id="member-password" name="password" class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm" />
            <p id="password-hint" class="text-xs text-muted-foreground hidden">Laat leeg om wachtwoord niet te wijzigen</p>
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium">Rol</label>
            <select id="member-role" name="role" class="flex h-10 w-full rounded-lg border border-input bg-background px-3 text-sm">
              <option value="member">Lid</option>
              <option value="admin">Beheerder</option>
            </select>
          </div>

          <div id="member-active-container" class="hidden">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="member-active" name="isActive" checked class="h-4 w-4 rounded border-gray-300 text-tesoro-500" />
              <span class="text-sm">Actief</span>
            </label>
          </div>

          <div class="flex justify-end gap-3 pt-4">
            <button type="button" id="cancel-member-btn" class="rounded-lg border px-4 py-2 text-sm font-medium hover:bg-muted">
              Annuleren
            </button>
            <button type="submit" class="rounded-lg bg-tesoro-500 px-4 py-2 text-sm font-medium text-white hover:bg-tesoro-600">
              Opslaan
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="delete-modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
      <div class="relative w-full max-w-sm rounded-2xl bg-card p-6 shadow-xl">
        <h2 class="text-lg font-semibold mb-2">Teamlid verwijderen</h2>
        <p id="delete-message" class="text-sm text-muted-foreground mb-6"></p>
        <input type="hidden" id="delete-member-id" />
        <div class="flex justify-end gap-3">
          <button id="cancel-delete-btn" class="rounded-lg border px-4 py-2 text-sm font-medium hover:bg-muted">
            Annuleren
          </button>
          <button id="confirm-delete-btn" class="rounded-lg bg-red-500 px-4 py-2 text-sm font-medium text-white hover:bg-red-600">
            Verwijderen
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Template Editor Modal -->
  <div id="template-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="template-modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 overflow-y-auto">
      <div class="relative w-full max-w-4xl rounded-2xl bg-card p-6 shadow-xl my-8">
        <button id="close-template-modal" class="absolute right-4 top-4 p-1 text-muted-foreground hover:text-foreground">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>

        <h2 id="template-modal-title" class="text-xl font-semibold mb-2">Email Template Bewerken</h2>
        <p id="template-modal-description" class="text-sm text-muted-foreground mb-6"></p>

        <form id="template-form" class="space-y-4">
          <input type="hidden" id="template-type" name="type" />

          <div class="space-y-2">
            <label class="text-sm font-medium">Onderwerp</label>
            <input type="text" id="template-subject" name="subject" required
              class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm"
              placeholder="Bijv: Uw offerte van Tesoro CRM - {{quote_number}}" />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium">HTML Inhoud</label>
            <textarea id="template-body-html" name="bodyHtml" rows="15" required
              class="flex w-full rounded-lg border border-input bg-background px-3 py-2 text-sm font-mono"
              placeholder="HTML template..."></textarea>
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium">Platte tekst (fallback)</label>
            <textarea id="template-body-text" name="bodyText" rows="6"
              class="flex w-full rounded-lg border border-input bg-background px-3 py-2 text-sm font-mono"
              placeholder="Platte tekst versie..."></textarea>
          </div>

          <!-- Available Variables -->
          <div class="rounded-lg border bg-muted/30 p-4">
            <p class="text-sm font-medium mb-2">Beschikbare variabelen:</p>
            <div class="flex flex-wrap gap-2">
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="quote_number">{`{{quote_number}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="quote_title">{`{{quote_title}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="quote_total">{`{{quote_total}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="quote_valid_until">{`{{quote_valid_until}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="quote_url">{`{{quote_url}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="customer_name">{`{{customer_name}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="customer_company">{`{{customer_company}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="company_name">{`{{company_name}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="company_email">{`{{company_email}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="signed_by">{`{{signed_by}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100" data-var="signed_at">{`{{signed_at}}`}</code>
            </div>
            <p class="text-xs text-muted-foreground mt-2">Klik op een variabele om te kopieren</p>
          </div>

          <div class="flex items-center justify-between pt-4 border-t">
            <button type="button" id="reset-template-btn"
              class="text-sm text-muted-foreground hover:text-destructive">
              Reset naar standaard
            </button>
            <div class="flex gap-3">
              <!-- Translate Dropdown -->
              <div class="relative">
                <button type="button" id="translate-template-btn"
                  class="flex items-center gap-2 rounded-lg border px-4 py-2 text-sm font-medium hover:bg-muted">
                  <span>üåê</span>
                  <span>Vertalen</span>
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div id="translate-dropdown" class="absolute right-0 bottom-full mb-2 hidden w-48 rounded-lg border bg-card shadow-lg z-10">
                  <div class="p-2 text-xs text-muted-foreground border-b">Vertaal naar:</div>
                  <button type="button" class="translate-option w-full px-4 py-2 text-left text-sm hover:bg-muted" data-lang="en">
                    üá¨üáß Engels
                  </button>
                  <button type="button" class="translate-option w-full px-4 py-2 text-left text-sm hover:bg-muted" data-lang="de">
                    üá©üá™ Duits
                  </button>
                  <button type="button" class="translate-option w-full px-4 py-2 text-left text-sm hover:bg-muted" data-lang="fr">
                    üá´üá∑ Frans
                  </button>
                  <button type="button" class="translate-option w-full px-4 py-2 text-left text-sm hover:bg-muted" data-lang="es">
                    üá™üá∏ Spaans
                  </button>
                  <button type="button" class="translate-option w-full px-4 py-2 text-left text-sm hover:bg-muted" data-lang="nl">
                    üá≥üá± Nederlands
                  </button>
                </div>
              </div>
              <button type="button" id="cancel-template-btn" class="rounded-lg border px-4 py-2 text-sm font-medium hover:bg-muted">
                Annuleren
              </button>
              <button type="submit" class="rounded-lg bg-tesoro-500 px-4 py-2 text-sm font-medium text-white hover:bg-tesoro-600">
                Opslaan
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Email Template Preview Modal -->
  <div id="preview-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="preview-modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 overflow-y-auto">
      <div class="relative w-full max-w-4xl rounded-2xl bg-card shadow-xl my-8">
        <div class="flex items-center justify-between border-b px-6 py-4">
          <div>
            <h2 id="preview-modal-title" class="text-xl font-semibold">Email Preview</h2>
            <p id="preview-modal-subject" class="text-sm text-muted-foreground mt-1"></p>
          </div>
          <button id="close-preview-modal" class="p-1 text-muted-foreground hover:text-foreground">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Mock data info -->
        <div class="border-b bg-blue-50 px-6 py-3">
          <p class="text-sm text-blue-800">
            <strong>Preview met voorbeelddata:</strong> Klant: Jan de Vries (Voorbeeld BV) | Offerte: OFF-2024-0042
          </p>
        </div>

        <!-- Email preview iframe -->
        <div class="p-6">
          <div class="border rounded-lg overflow-hidden bg-white">
            <iframe id="preview-iframe" class="w-full" style="height: 500px; border: none;"></iframe>
          </div>
        </div>

        <div class="flex justify-end border-t px-6 py-4">
          <button id="close-preview-btn" class="rounded-lg border px-4 py-2 text-sm font-medium hover:bg-muted">
            Sluiten
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Text Template Editor Modal -->
  <div id="text-template-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="text-template-modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 overflow-y-auto">
      <div class="relative w-full max-w-2xl rounded-2xl bg-card p-6 shadow-xl my-8">
        <button id="close-text-template-modal" class="absolute right-4 top-4 p-1 text-muted-foreground hover:text-foreground">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>

        <h2 id="text-template-modal-title" class="text-xl font-semibold mb-2">Tekst Template</h2>
        <p id="text-template-modal-description" class="text-sm text-muted-foreground mb-6"></p>

        <form id="text-template-form" class="space-y-4">
          <input type="hidden" id="text-template-id" name="id" />
          <input type="hidden" id="text-template-type" name="type" />

          <div class="space-y-2">
            <label class="text-sm font-medium">Naam *</label>
            <input type="text" id="text-template-name" name="name" required
              class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm"
              placeholder="Bijv: Standaard introductie" />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium">Beschrijving</label>
            <input type="text" id="text-template-description" name="description"
              class="flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm"
              placeholder="Korte beschrijving van dit template" />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium">Inhoud *</label>
            <textarea id="text-template-content" name="content" rows="10" required
              class="flex w-full rounded-lg border border-input bg-background px-3 py-2 text-sm"
              placeholder="De template tekst..."></textarea>
          </div>

          <!-- Available Variables -->
          <div class="rounded-lg border bg-muted/30 p-4">
            <p class="text-sm font-medium mb-2">Beschikbare variabelen:</p>
            <div class="flex flex-wrap gap-2">
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100 text-var-copy" data-var="customer_name">{`{{customer_name}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100 text-var-copy" data-var="customer_company">{`{{customer_company}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100 text-var-copy" data-var="quote_title">{`{{quote_title}}`}</code>
              <code class="rounded bg-muted px-2 py-1 text-xs cursor-pointer hover:bg-tesoro-100 text-var-copy" data-var="company_name">{`{{company_name}}`}</code>
            </div>
            <p class="text-xs text-muted-foreground mt-2">Klik op een variabele om te kopieren</p>
          </div>

          <label class="flex items-center gap-2">
            <input type="checkbox" id="text-template-default" name="isDefault" class="h-4 w-4 rounded border-gray-300 text-tesoro-500" />
            <span class="text-sm">Instellen als standaard voor dit type</span>
          </label>

          <div class="flex justify-end gap-3 pt-4 border-t">
            <button type="button" id="delete-text-template-btn" class="text-sm text-destructive hover:text-destructive/80 mr-auto hidden">
              Verwijderen
            </button>
            <button type="button" id="cancel-text-template-btn" class="rounded-lg border px-4 py-2 text-sm font-medium hover:bg-muted">
              Annuleren
            </button>
            <button type="submit" class="rounded-lg bg-tesoro-500 px-4 py-2 text-sm font-medium text-white hover:bg-tesoro-600">
              Opslaan
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</DashboardLayout>

<script>
  // Tab switching
  const tabs = document.querySelectorAll('[data-tab]');
  const tabContents = document.querySelectorAll('[id^="tab-"]');

  tabs.forEach((tab) => {
    tab.addEventListener('click', () => {
      const tabId = tab.getAttribute('data-tab');

      tabs.forEach((t) => {
        t.classList.remove('border-tesoro-500', 'text-tesoro-600');
        t.classList.add('border-transparent', 'text-muted-foreground');
      });
      tab.classList.add('border-tesoro-500', 'text-tesoro-600');
      tab.classList.remove('border-transparent', 'text-muted-foreground');

      tabContents.forEach((content) => {
        if (content.id === `tab-${tabId}`) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
    });
  });

  // Settings forms
  const companyForm = document.getElementById('company-form') as HTMLFormElement;
  const quoteSettingsForm = document.getElementById('quote-settings-form') as HTMLFormElement;
  const companySaveStatus = document.getElementById('company-save-status');
  const quoteSaveStatus = document.getElementById('quote-save-status');

  async function saveSettings(formData: FormData, statusEl: HTMLElement | null) {
    const data: Record<string, unknown> = {};
    formData.forEach((value, key) => {
      if (key.includes('checkbox') || value === 'on') return;
      data[key] = value;
    });

    // Handle checkboxes
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach((cb) => {
      const input = cb as HTMLInputElement;
      if (input.name && !input.name.includes('member') && !input.name.includes('Active')) {
        data[input.name] = input.checked;
      }
    });

    try {
      const response = await fetch('/api/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (response.ok && statusEl) {
        statusEl.classList.remove('hidden');
        setTimeout(() => statusEl.classList.add('hidden'), 2000);
      } else {
        alert('Er is iets misgegaan bij het opslaan');
      }
    } catch {
      alert('Er is iets misgegaan bij het opslaan');
    }
  }

  companyForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveSettings(new FormData(companyForm), companySaveStatus);
  });

  quoteSettingsForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveSettings(new FormData(quoteSettingsForm), quoteSaveStatus);
  });

  // Team Member Modal
  const memberModal = document.getElementById('member-modal');
  const memberModalTitle = document.getElementById('member-modal-title');
  const memberForm = document.getElementById('member-form') as HTMLFormElement;
  const memberIdInput = document.getElementById('member-id') as HTMLInputElement;
  const memberNameInput = document.getElementById('member-name') as HTMLInputElement;
  const memberEmailInput = document.getElementById('member-email') as HTMLInputElement;
  const memberPasswordInput = document.getElementById('member-password') as HTMLInputElement;
  const memberRoleInput = document.getElementById('member-role') as HTMLSelectElement;
  const memberActiveInput = document.getElementById('member-active') as HTMLInputElement;
  const memberActiveContainer = document.getElementById('member-active-container');
  const passwordRequired = document.getElementById('password-required');
  const passwordHint = document.getElementById('password-hint');

  function showMemberModal(editMode = false) {
    memberModal?.classList.remove('hidden');
    if (memberModalTitle) {
      memberModalTitle.textContent = editMode ? 'Teamlid Bewerken' : 'Nieuw Teamlid';
    }
    if (editMode) {
      memberActiveContainer?.classList.remove('hidden');
      passwordRequired?.classList.add('hidden');
      passwordHint?.classList.remove('hidden');
      memberPasswordInput.required = false;
    } else {
      memberActiveContainer?.classList.add('hidden');
      passwordRequired?.classList.remove('hidden');
      passwordHint?.classList.add('hidden');
      memberPasswordInput.required = true;
    }
  }

  function hideMemberModal() {
    memberModal?.classList.add('hidden');
    memberForm?.reset();
    if (memberIdInput) memberIdInput.value = '';
  }

  document.getElementById('add-member-btn')?.addEventListener('click', () => showMemberModal(false));
  document.getElementById('close-member-modal')?.addEventListener('click', hideMemberModal);
  document.getElementById('cancel-member-btn')?.addEventListener('click', hideMemberModal);
  document.getElementById('member-modal-backdrop')?.addEventListener('click', hideMemberModal);

  // Edit member buttons
  document.querySelectorAll('.edit-member-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-member-id');
      const name = btn.getAttribute('data-member-name');
      const email = btn.getAttribute('data-member-email');
      const role = btn.getAttribute('data-member-role');
      const active = btn.getAttribute('data-member-active') === 'true';

      if (memberIdInput) memberIdInput.value = id || '';
      if (memberNameInput) memberNameInput.value = name || '';
      if (memberEmailInput) memberEmailInput.value = email || '';
      if (memberRoleInput) memberRoleInput.value = role || 'member';
      if (memberActiveInput) memberActiveInput.checked = active;

      showMemberModal(true);
    });
  });

  // Member form submit
  memberForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(memberForm);
    const data: Record<string, unknown> = {};
    formData.forEach((value, key) => {
      if (key === 'isActive') return;
      if (value) data[key] = value;
    });
    data.isActive = memberActiveInput?.checked ?? true;

    const isEdit = Boolean(data.id);

    try {
      const url = isEdit ? `/api/team-members/${data.id}` : '/api/team-members';
      const method = isEdit ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const error = await response.json();
        alert(error.error || 'Er is iets misgegaan');
      }
    } catch {
      alert('Er is iets misgegaan');
    }
  });

  // Delete Modal
  const deleteModal = document.getElementById('delete-modal');
  const deleteMessage = document.getElementById('delete-message');
  const deleteMemberIdInput = document.getElementById('delete-member-id') as HTMLInputElement;

  function showDeleteModal(id: string, name: string) {
    deleteModal?.classList.remove('hidden');
    if (deleteMessage) {
      deleteMessage.textContent = `Weet je zeker dat je "${name}" wilt verwijderen?`;
    }
    if (deleteMemberIdInput) deleteMemberIdInput.value = id;
  }

  function hideDeleteModal() {
    deleteModal?.classList.add('hidden');
    if (deleteMemberIdInput) deleteMemberIdInput.value = '';
  }

  document.getElementById('cancel-delete-btn')?.addEventListener('click', hideDeleteModal);
  document.getElementById('delete-modal-backdrop')?.addEventListener('click', hideDeleteModal);

  document.querySelectorAll('.delete-member-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-member-id');
      const name = btn.getAttribute('data-member-name');
      if (id && name) showDeleteModal(id, name);
    });
  });

  document.getElementById('confirm-delete-btn')?.addEventListener('click', async () => {
    const id = deleteMemberIdInput?.value;
    if (!id) return;

    try {
      const response = await fetch(`/api/team-members/${id}`, { method: 'DELETE' });

      if (response.ok) {
        window.location.reload();
      } else {
        const error = await response.json();
        alert(error.error || 'Er is iets misgegaan');
      }
    } catch {
      alert('Er is iets misgegaan');
    }
  });

  // Email Template Preview modal elements
  const previewModal = document.getElementById('preview-modal');
  const previewModalTitle = document.getElementById('preview-modal-title');
  const previewModalSubject = document.getElementById('preview-modal-subject');
  const previewIframe = document.getElementById('preview-iframe') as HTMLIFrameElement;

  function showPreviewModal() {
    previewModal?.classList.remove('hidden');
  }

  function hidePreviewModal() {
    previewModal?.classList.add('hidden');
    if (previewIframe) previewIframe.srcdoc = '';
  }

  document.getElementById('close-preview-modal')?.addEventListener('click', hidePreviewModal);
  document.getElementById('close-preview-btn')?.addEventListener('click', hidePreviewModal);
  document.getElementById('preview-modal-backdrop')?.addEventListener('click', hidePreviewModal);

  // Preview template buttons
  document.querySelectorAll('.preview-template-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const type = btn.getAttribute('data-template-id');
      const name = btn.getAttribute('data-template-name');
      if (!type) return;

      try {
        const response = await fetch(`/api/email-templates/preview?type=${type}`);
        if (response.ok) {
          const data = await response.json();

          if (previewModalTitle) previewModalTitle.textContent = `Preview: ${name}`;
          if (previewModalSubject) previewModalSubject.textContent = `Onderwerp: ${data.subject}`;
          if (previewIframe) previewIframe.srcdoc = data.html;

          showPreviewModal();
        } else {
          alert('Kon preview niet laden');
        }
      } catch {
        alert('Kon preview niet laden');
      }
    });
  });

  // =====================
  // TEMPLATE TRANSLATION
  // =====================
  const translateBtn = document.getElementById('translate-template-btn');
  const translateDropdown = document.getElementById('translate-dropdown');
  const translateOptions = document.querySelectorAll('.translate-option');
  const templateSubjectInput = document.getElementById('template-subject') as HTMLInputElement | null;
  const templateBodyHtmlInput = document.getElementById('template-body-html') as HTMLTextAreaElement | null;
  const templateBodyTextInput = document.getElementById('template-body-text') as HTMLTextAreaElement | null;

  // Toggle translate dropdown
  translateBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    translateDropdown?.classList.toggle('hidden');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', () => {
    translateDropdown?.classList.add('hidden');
  });

  // Handle translation
  translateOptions.forEach(option => {
    option.addEventListener('click', async (e) => {
      e.stopPropagation();
      const targetLang = option.getAttribute('data-lang');
      if (!targetLang) return;

      const langNames: Record<string, string> = {
        en: 'Engels',
        de: 'Duits',
        fr: 'Frans',
        es: 'Spaans',
        nl: 'Nederlands',
      };

      translateDropdown?.classList.add('hidden');

      // Get current template values
      const subject = templateSubjectInput?.value || '';
      const bodyHtml = templateBodyHtmlInput?.value || '';
      const bodyText = templateBodyTextInput?.value || '';

      if (!subject && !bodyHtml) {
        alert('Vul eerst de template in voordat je vertaalt');
        return;
      }

      // Show loading state
      const originalBtnText = translateBtn?.innerHTML || '';
      if (translateBtn) {
        translateBtn.innerHTML = `<span class="animate-spin">‚è≥</span> Vertalen naar ${langNames[targetLang]}...`;
        translateBtn.setAttribute('disabled', 'true');
      }

      try {
        const response = await fetch('/api/ai/translate-template', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject,
            bodyHtml,
            bodyText,
            targetLanguage: targetLang,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Vertaling mislukt');
        }

        // Update the form fields with translated content
        if (templateSubjectInput && data.translated?.subject) {
          templateSubjectInput.value = data.translated.subject;
        }
        if (templateBodyHtmlInput && data.translated?.bodyHtml) {
          templateBodyHtmlInput.value = data.translated.bodyHtml;
        }
        if (templateBodyTextInput && data.translated?.bodyText) {
          templateBodyTextInput.value = data.translated.bodyText;
        }

        // Show success message
        const providerName = data.provider === 'openai' ? 'OpenAI' : 'Anthropic';
        alert(`‚úÖ Template vertaald naar ${langNames[targetLang]} via ${providerName}!\n\nControleer de vertaling en klik op Opslaan om te bewaren.`);
      } catch (error: any) {
        console.error('Translation error:', error);
        alert(`‚ùå ${error.message || 'Er is iets misgegaan bij het vertalen'}`);
      } finally {
        // Restore button state
        if (translateBtn) {
          translateBtn.innerHTML = originalBtnText;
          translateBtn.removeAttribute('disabled');
        }
      }
    });
  });

  // =====================
  // TEXT TEMPLATES
  // =====================
  const textTemplateModal = document.getElementById('text-template-modal');
  const textTemplateModalTitle = document.getElementById('text-template-modal-title');
  const textTemplateModalDescription = document.getElementById('text-template-modal-description');
  const textTemplateForm = document.getElementById('text-template-form') as HTMLFormElement;
  const textTemplateIdInput = document.getElementById('text-template-id') as HTMLInputElement;
  const textTemplateTypeInput = document.getElementById('text-template-type') as HTMLInputElement;
  const textTemplateNameInput = document.getElementById('text-template-name') as HTMLInputElement;
  const textTemplateDescriptionInput = document.getElementById('text-template-description') as HTMLInputElement;
  const textTemplateContentInput = document.getElementById('text-template-content') as HTMLTextAreaElement;
  const textTemplateDefaultInput = document.getElementById('text-template-default') as HTMLInputElement;
  const deleteTextTemplateBtn = document.getElementById('delete-text-template-btn');

  interface TextTemplate {
    id: string;
    type: string;
    name: string;
    description: string | null;
    content: string;
    isDefault: boolean;
  }

  const typeNames: Record<string, string> = {
    'intro': 'Introductie',
    'footer': 'Afsluiting',
    'terms': 'Voorwaarden',
    'custom': 'Aangepast',
  };

  // Load text templates on page load
  async function loadTextTemplates() {
    try {
      const response = await fetch('/api/text-templates');
      if (!response.ok) return;

      const templates: TextTemplate[] = await response.json();

      // Group by type
      const byType: Record<string, TextTemplate[]> = {};
      templates.forEach(t => {
        if (!byType[t.type]) byType[t.type] = [];
        byType[t.type].push(t);
      });

      // Render each category
      document.querySelectorAll('.template-list').forEach(list => {
        const type = list.getAttribute('data-type');
        if (!type) return;

        const typeTemplates = byType[type] || [];

        if (typeTemplates.length === 0) {
          list.innerHTML = `
            <div class="p-6 text-center text-muted-foreground text-sm">
              <p>Geen templates voor dit type</p>
            </div>
          `;
        } else {
          list.innerHTML = typeTemplates.map(t => `
            <div class="flex items-center justify-between px-6 py-4 hover:bg-muted/30">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <p class="font-medium">${t.name}</p>
                  ${t.isDefault ? '<span class="text-xs bg-tesoro-100 text-tesoro-700 px-2 py-0.5 rounded-full">Standaard</span>' : ''}
                </div>
                ${t.description ? `<p class="text-sm text-muted-foreground">${t.description}</p>` : ''}
              </div>
              <button
                class="edit-text-template-btn rounded-lg border px-3 py-1.5 text-sm hover:bg-muted"
                data-template-id="${t.id}"
              >
                Bewerken
              </button>
            </div>
          `).join('');

          // Add click handlers
          list.querySelectorAll('.edit-text-template-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = btn.getAttribute('data-template-id');
              if (id) openTextTemplateForEdit(id);
            });
          });
        }
      });
    } catch (error) {
      console.error('Failed to load text templates:', error);
    }
  }

  function showTextTemplateModal() {
    textTemplateModal?.classList.remove('hidden');
  }

  function hideTextTemplateModal() {
    textTemplateModal?.classList.add('hidden');
    textTemplateForm?.reset();
    if (textTemplateIdInput) textTemplateIdInput.value = '';
    if (deleteTextTemplateBtn) deleteTextTemplateBtn.classList.add('hidden');
  }

  function openTextTemplateForNew(type: string, typeName: string) {
    if (textTemplateIdInput) textTemplateIdInput.value = '';
    if (textTemplateTypeInput) textTemplateTypeInput.value = type;
    if (textTemplateNameInput) textTemplateNameInput.value = '';
    if (textTemplateDescriptionInput) textTemplateDescriptionInput.value = '';
    if (textTemplateContentInput) textTemplateContentInput.value = '';
    if (textTemplateDefaultInput) textTemplateDefaultInput.checked = false;
    if (textTemplateModalTitle) textTemplateModalTitle.textContent = `Nieuwe ${typeName} template`;
    if (textTemplateModalDescription) textTemplateModalDescription.textContent = `Maak een nieuwe ${typeName.toLowerCase()} template`;
    if (deleteTextTemplateBtn) deleteTextTemplateBtn.classList.add('hidden');
    showTextTemplateModal();
  }

  async function openTextTemplateForEdit(id: string) {
    try {
      const response = await fetch(`/api/text-templates/${id}`);
      if (!response.ok) {
        alert('Kon template niet laden');
        return;
      }

      const template: TextTemplate = await response.json();

      if (textTemplateIdInput) textTemplateIdInput.value = template.id;
      if (textTemplateTypeInput) textTemplateTypeInput.value = template.type;
      if (textTemplateNameInput) textTemplateNameInput.value = template.name;
      if (textTemplateDescriptionInput) textTemplateDescriptionInput.value = template.description || '';
      if (textTemplateContentInput) textTemplateContentInput.value = template.content;
      if (textTemplateDefaultInput) textTemplateDefaultInput.checked = template.isDefault;
      if (textTemplateModalTitle) textTemplateModalTitle.textContent = `${template.name} bewerken`;
      if (textTemplateModalDescription) textTemplateModalDescription.textContent = `${typeNames[template.type] || template.type} template`;
      if (deleteTextTemplateBtn) deleteTextTemplateBtn.classList.remove('hidden');

      showTextTemplateModal();
    } catch {
      alert('Kon template niet laden');
    }
  }

  // Modal close handlers
  document.getElementById('close-text-template-modal')?.addEventListener('click', hideTextTemplateModal);
  document.getElementById('cancel-text-template-btn')?.addEventListener('click', hideTextTemplateModal);
  document.getElementById('text-template-modal-backdrop')?.addEventListener('click', hideTextTemplateModal);

  // Add template buttons
  document.querySelectorAll('.add-category-template-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.getAttribute('data-category');
      const typeName = btn.getAttribute('data-category-name');
      if (type && typeName) openTextTemplateForNew(type, typeName);
    });
  });

  document.getElementById('add-text-template-btn')?.addEventListener('click', () => {
    openTextTemplateForNew('custom', 'Aangepaste');
  });

  // Form submit
  textTemplateForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = textTemplateIdInput?.value;
    const isEdit = Boolean(id);

    const data = {
      type: textTemplateTypeInput?.value,
      name: textTemplateNameInput?.value,
      description: textTemplateDescriptionInput?.value || null,
      content: textTemplateContentInput?.value,
      isDefault: textTemplateDefaultInput?.checked,
    };

    try {
      const url = isEdit ? `/api/text-templates/${id}` : '/api/text-templates';
      const method = isEdit ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        hideTextTemplateModal();
        loadTextTemplates();
      } else {
        const error = await response.json();
        alert(error.error || 'Er is iets misgegaan');
      }
    } catch {
      alert('Er is iets misgegaan');
    }
  });

  // Delete template
  deleteTextTemplateBtn?.addEventListener('click', async () => {
    const id = textTemplateIdInput?.value;
    if (!id) return;

    if (!confirm('Weet je zeker dat je dit template wilt verwijderen?')) return;

    try {
      const response = await fetch(`/api/text-templates/${id}`, { method: 'DELETE' });

      if (response.ok) {
        hideTextTemplateModal();
        loadTextTemplates();
      } else {
        alert('Kon template niet verwijderen');
      }
    } catch {
      alert('Er is iets misgegaan');
    }
  });

  // Load on page load
  loadTextTemplates();

  // =====================
  // API Key Management
  // =====================
  async function loadApiKeyStatus() {
    try {
      const response = await fetch('/api/settings/api-keys');
      if (!response.ok) throw new Error('Failed to load API keys');

      const status = await response.json();

      Object.entries(status).forEach(([key, data]: [string, any]) => {
        const container = document.querySelector(`[data-api-key="${key}"]`);
        if (!container) return;

        const statusEl = container.querySelector('.api-key-status');
        const deleteBtn = container.querySelector('.api-key-delete');
        const input = container.querySelector('.api-key-input') as HTMLInputElement;

        if (data.configured) {
          if (statusEl) {
            statusEl.textContent = 'Geconfigureerd';
            statusEl.className = 'api-key-status rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800';
          }
          if (deleteBtn) deleteBtn.classList.remove('hidden');
          // Show masked key in input
          if (input && data.maskedKey) {
            input.value = data.maskedKey;
            input.type = 'text';
            input.disabled = true;
            input.classList.add('bg-muted', 'text-muted-foreground');
          }
        } else {
          if (statusEl) {
            statusEl.textContent = 'Niet geconfigureerd';
            statusEl.className = 'api-key-status rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800';
          }
          if (deleteBtn) deleteBtn.classList.add('hidden');
          // Reset input for new key entry
          if (input) {
            input.value = '';
            input.type = 'password';
            input.disabled = false;
            input.classList.remove('bg-muted', 'text-muted-foreground');
          }
        }
      });
    } catch (error) {
      console.error('Failed to load API key status:', error);
    }
  }

  // Save API key
  document.querySelectorAll('.api-key-save').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const container = btn.closest('[data-api-key]');
      if (!container) return;

      const type = container.getAttribute('data-api-key');
      const input = container.querySelector('.api-key-input') as HTMLInputElement;
      const apiKey = input?.value;

      if (!apiKey) {
        alert('Voer een API key in');
        return;
      }

      try {
        const response = await fetch('/api/settings/api-keys', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, apiKey }),
        });

        if (!response.ok) throw new Error('Failed to save API key');

        input.value = '';
        await loadApiKeyStatus();
        alert('API key opgeslagen!');
      } catch (error) {
        console.error('Failed to save API key:', error);
        alert('Fout bij opslaan van API key');
      }
    });
  });

  // Delete API key
  document.querySelectorAll('.api-key-delete').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const container = btn.closest('[data-api-key]');
      if (!container) return;

      const type = container.getAttribute('data-api-key');

      if (!confirm('Weet je zeker dat je deze API key wilt verwijderen?')) return;

      try {
        const response = await fetch('/api/settings/api-keys', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type }),
        });

        if (!response.ok) throw new Error('Failed to delete API key');

        await loadApiKeyStatus();
        alert('API key verwijderd!');
      } catch (error) {
        console.error('Failed to delete API key:', error);
        alert('Fout bij verwijderen van API key');
      }
    });
  });

  // Load API key status on page load
  loadApiKeyStatus();

  // =====================
  // Discord Settings
  // =====================
  const discordLoading = document.getElementById('discord-loading');
  const discordForm = document.getElementById('discord-form');
  const discordEnabled = document.getElementById('discord-enabled') as HTMLInputElement;
  const discordWebhookUrl = document.getElementById('discord-webhook-url') as HTMLInputElement;
  const discordSaveBtn = document.getElementById('discord-save-btn');
  const discordTestBtn = document.getElementById('discord-test-btn');
  const discordSaveStatus = document.getElementById('discord-save-status');

  const eventTypes = [
    'quote_request_received',
    'quote_viewed',
    'quote_accepted',
    'quote_declined',
    'question_received',
    'payment_received',
  ];

  interface DiscordSettings {
    webhookUrl: string;
    hasWebhookUrl: boolean;
    enabled: boolean;
    events: Record<string, boolean>;
  }

  let currentDiscordSettings: DiscordSettings | null = null;

  async function loadDiscordSettings() {
    try {
      const response = await fetch('/api/settings/discord');
      if (!response.ok) throw new Error('Failed to load Discord settings');

      const settings: DiscordSettings = await response.json();
      currentDiscordSettings = settings;

      // Update UI
      if (discordEnabled) discordEnabled.checked = settings.enabled;
      if (discordWebhookUrl) {
        if (settings.hasWebhookUrl) {
          discordWebhookUrl.value = settings.webhookUrl;
          discordWebhookUrl.type = 'text';
        } else {
          discordWebhookUrl.value = '';
          discordWebhookUrl.type = 'password';
        }
      }

      // Update event checkboxes
      eventTypes.forEach(event => {
        const checkbox = document.getElementById(`discord-event-${event}`) as HTMLInputElement;
        if (checkbox) {
          checkbox.checked = settings.events?.[event] ?? true;
        }
      });

      // Show form, hide loading
      discordLoading?.classList.add('hidden');
      discordForm?.classList.remove('hidden');
    } catch (error) {
      console.error('Failed to load Discord settings:', error);
      if (discordLoading) {
        discordLoading.textContent = 'Kon instellingen niet laden';
      }
    }
  }

  async function saveDiscordSettings() {
    const events: Record<string, boolean> = {};
    eventTypes.forEach(event => {
      const checkbox = document.getElementById(`discord-event-${event}`) as HTMLInputElement;
      if (checkbox) {
        events[event] = checkbox.checked;
      }
    });

    const data: any = {
      enabled: discordEnabled?.checked ?? false,
      events,
    };

    // Only include webhookUrl if it's changed (not the masked version)
    const webhookValue = discordWebhookUrl?.value || '';
    if (webhookValue && !webhookValue.startsWith('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
      data.webhookUrl = webhookValue;
    }

    try {
      const response = await fetch('/api/settings/discord', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to save');
      }

      // Show success
      if (discordSaveStatus) {
        discordSaveStatus.classList.remove('hidden');
        setTimeout(() => discordSaveStatus.classList.add('hidden'), 2000);
      }

      // Reload settings to get updated masked URL
      await loadDiscordSettings();
    } catch (error: any) {
      console.error('Failed to save Discord settings:', error);
      alert(error.message || 'Fout bij opslaan van Discord instellingen');
    }
  }

  async function testDiscordWebhook() {
    const webhookValue = discordWebhookUrl?.value || '';

    // Check if we need to use the saved webhook or a new one
    const data: any = {};
    if (webhookValue && !webhookValue.startsWith('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
      data.webhookUrl = webhookValue;
    }

    if (discordTestBtn) {
      discordTestBtn.textContent = 'Testen...';
      discordTestBtn.setAttribute('disabled', 'true');
    }

    try {
      const response = await fetch('/api/settings/discord', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        alert('Test notificatie verstuurd! Check je Discord kanaal.');
      } else {
        throw new Error(result.error || 'Failed to send test');
      }
    } catch (error: any) {
      console.error('Failed to test Discord webhook:', error);
      alert(error.message || 'Fout bij testen van webhook');
    } finally {
      if (discordTestBtn) {
        discordTestBtn.textContent = 'Testen';
        discordTestBtn.removeAttribute('disabled');
      }
    }
  }

  // Event listeners
  discordSaveBtn?.addEventListener('click', saveDiscordSettings);
  discordTestBtn?.addEventListener('click', testDiscordWebhook);

  // Clear webhook URL field when user starts typing (to replace masked value)
  discordWebhookUrl?.addEventListener('focus', () => {
    if (discordWebhookUrl.value.startsWith('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
      discordWebhookUrl.value = '';
      discordWebhookUrl.type = 'password';
    }
  });

  // Load Discord settings on page load
  loadDiscordSettings();

  // =====================
  // AI Gateway Settings
  // =====================
  const aiGatewayLoading = document.getElementById('ai-gateway-loading');
  const aiGatewayForm = document.getElementById('ai-gateway-form');
  const aiGatewayError = document.getElementById('ai-gateway-error');
  const aiGatewaySuccess = document.getElementById('ai-gateway-success');
  const aiGatewayStatus = document.getElementById('ai-gateway-status');
  const aiGatewayAccountId = document.getElementById('ai-gateway-account-id') as HTMLInputElement;
  const aiGatewayName = document.getElementById('ai-gateway-name') as HTMLInputElement;
  const aiTestBtn = document.getElementById('ai-test-btn');
  const aiSaveBtn = document.getElementById('ai-save-btn');
  const aiProviderOptions = document.querySelectorAll('.ai-provider-option');

  let selectedProvider: string = 'anthropic';

  interface AIGatewayData {
    gatewayAccountId: string | null;
    gatewayName: string | null;
    gatewayEnabled: boolean;
    provider: string;
    providers: Array<{
      id: string;
      name: string;
      configured: boolean;
      active: boolean;
    }>;
  }

  async function loadAIGatewaySettings() {
    try {
      const response = await fetch('/api/settings/ai-gateway');
      if (!response.ok) throw new Error('Failed to load settings');

      const data: AIGatewayData = await response.json();
      selectedProvider = data.provider;

      // Update gateway fields
      if (aiGatewayAccountId && data.gatewayAccountId) {
        aiGatewayAccountId.value = data.gatewayAccountId;
      }
      if (aiGatewayName && data.gatewayName) {
        aiGatewayName.value = data.gatewayName;
      }

      // Update gateway status
      if (aiGatewayStatus) {
        if (data.gatewayEnabled) {
          aiGatewayStatus.textContent = '‚úì Actief';
          aiGatewayStatus.className = 'text-xs text-green-600';
        } else {
          aiGatewayStatus.textContent = 'Niet geconfigureerd';
          aiGatewayStatus.className = 'text-xs text-muted-foreground';
        }
      }

      // Update provider options
      aiProviderOptions.forEach((option) => {
        const providerId = option.getAttribute('data-provider');
        const providerData = data.providers.find(p => p.id === providerId);
        const statusEl = option.querySelector('.ai-provider-status');
        const checkEl = option.querySelector('.ai-provider-check');
        const radioInput = option.querySelector('input[type="radio"]') as HTMLInputElement;

        if (providerData) {
          // Show configuration status
          if (statusEl) {
            if (providerData.configured) {
              statusEl.textContent = '‚úì API key geconfigureerd';
              statusEl.className = 'ai-provider-status mt-2 inline-block text-xs text-green-600';
            } else {
              statusEl.textContent = '‚ö† API key ontbreekt';
              statusEl.className = 'ai-provider-status mt-2 inline-block text-xs text-yellow-600';
            }
          }

          // Show active state
          if (providerData.active) {
            option.classList.add('border-tesoro-500', 'bg-tesoro-50');
            checkEl?.classList.remove('hidden');
            if (radioInput) radioInput.checked = true;
          } else {
            option.classList.remove('border-tesoro-500', 'bg-tesoro-50');
            checkEl?.classList.add('hidden');
            if (radioInput) radioInput.checked = false;
          }

          // Dim if not configured
          if (!providerData.configured) {
            option.classList.add('opacity-60');
          } else {
            option.classList.remove('opacity-60');
          }
        }
      });

      // Show form, hide loading
      aiGatewayLoading?.classList.add('hidden');
      aiGatewayForm?.classList.remove('hidden');
    } catch (error) {
      console.error('Failed to load AI gateway settings:', error);
      if (aiGatewayLoading) {
        aiGatewayLoading.textContent = 'Kon instellingen niet laden';
      }
    }
  }

  async function saveAIGatewaySettings() {
    hideMessages();

    try {
      const data: Record<string, string> = {
        provider: selectedProvider,
      };

      // Only send gateway values if they've been entered
      const accountId = aiGatewayAccountId?.value?.trim() || '';
      const gatewayName = aiGatewayName?.value?.trim() || '';

      if (accountId && !accountId.startsWith('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
        data.gatewayAccountId = accountId;
      }
      if (gatewayName) {
        data.gatewayName = gatewayName;
      }

      const response = await fetch('/api/settings/ai-gateway', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Opslaan mislukt');
      }

      showSuccess('Instellingen opgeslagen!');
      await loadAIGatewaySettings();
    } catch (error: any) {
      console.error('Failed to save AI gateway settings:', error);
      showError(error.message || 'Fout bij opslaan');
    }
  }

  async function testAIConnection() {
    hideMessages();

    const originalText = aiTestBtn?.innerHTML || '';
    if (aiTestBtn) {
      aiTestBtn.innerHTML = '<span class="animate-spin">‚è≥</span> Testen...';
      aiTestBtn.setAttribute('disabled', 'true');
    }

    try {
      const response = await fetch('/api/settings/ai-gateway', {
        method: 'POST',
      });

      const result = await response.json();

      if (result.success) {
        const gatewayText = result.gateway ? ' via AI Gateway' : ' (directe verbinding)';
        showSuccess(`‚úÖ Verbinding OK! Provider: ${result.provider}${gatewayText} (${result.duration})`);
      } else {
        showError(result.error || 'Test mislukt');
      }
    } catch (error: any) {
      console.error('AI test failed:', error);
      showError(error.message || 'Verbinding mislukt');
    } finally {
      if (aiTestBtn) {
        aiTestBtn.innerHTML = originalText;
        aiTestBtn.removeAttribute('disabled');
      }
    }
  }

  function showError(message: string) {
    if (aiGatewayError) {
      aiGatewayError.textContent = message;
      aiGatewayError.classList.remove('hidden');
    }
  }

  function showSuccess(message: string) {
    if (aiGatewaySuccess) {
      aiGatewaySuccess.textContent = message;
      aiGatewaySuccess.classList.remove('hidden');
      setTimeout(() => aiGatewaySuccess.classList.add('hidden'), 3000);
    }
  }

  function hideMessages() {
    aiGatewayError?.classList.add('hidden');
    aiGatewaySuccess?.classList.add('hidden');
  }

  // Provider selection click handler
  aiProviderOptions.forEach((option) => {
    option.addEventListener('click', () => {
      const provider = option.getAttribute('data-provider');
      if (provider) {
        selectedProvider = provider;

        // Update UI immediately
        aiProviderOptions.forEach((opt) => {
          const checkEl = opt.querySelector('.ai-provider-check');
          if (opt.getAttribute('data-provider') === provider) {
            opt.classList.add('border-tesoro-500', 'bg-tesoro-50');
            checkEl?.classList.remove('hidden');
          } else {
            opt.classList.remove('border-tesoro-500', 'bg-tesoro-50');
            checkEl?.classList.add('hidden');
          }
        });
      }
    });
  });

  // Event listeners
  aiSaveBtn?.addEventListener('click', saveAIGatewaySettings);
  aiTestBtn?.addEventListener('click', testAIConnection);

  // Clear masked values on focus
  aiGatewayAccountId?.addEventListener('focus', () => {
    if (aiGatewayAccountId.value.startsWith('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
      aiGatewayAccountId.value = '';
    }
  });

  // Load settings on page load
  loadAIGatewaySettings();
</script>
