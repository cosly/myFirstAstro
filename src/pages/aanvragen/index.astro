---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { createDb, quoteRequests } from '../../lib/db';
import { desc } from 'drizzle-orm';

// Fetch from database
type Request = {
  id: string;
  companyName: string | null;
  contactName: string;
  contactEmail: string;
  serviceType: string;
  description: string;
  budgetIndication: string | null;
  status: string;
  createdAt: Date;
};

let requests: Request[] = [];

try {
  const db = createDb(Astro.locals.runtime.env.DB);

  const dbRequests = await db
    .select()
    .from(quoteRequests)
    .orderBy(desc(quoteRequests.createdAt));

  requests = dbRequests.map(r => ({
    id: r.id,
    companyName: r.companyName,
    contactName: r.contactName,
    contactEmail: r.contactEmail,
    serviceType: r.serviceType,
    description: r.description,
    budgetIndication: r.budgetIndication,
    status: r.status,
    createdAt: r.createdAt,
  }));
} catch (error) {
  console.error('Failed to fetch requests:', error);
}

const statusColors: Record<string, string> = {
  new: 'bg-red-100 text-red-800',
  in_progress: 'bg-yellow-100 text-yellow-800',
  quoted: 'bg-green-100 text-green-800',
  closed: 'bg-gray-100 text-gray-800',
};

const statusLabels: Record<string, string> = {
  new: 'Nieuw',
  in_progress: 'In behandeling',
  quoted: 'Offerte gemaakt',
  closed: 'Gesloten',
};

const typeIcons: Record<string, string> = {
  website: 'üåê',
  crm_setup: '‚öôÔ∏è',
  marketing: 'üé®',
  support: 'üîß',
  other: 'üìù',
};

const typeLabels: Record<string, string> = {
  website: 'Website',
  crm_setup: 'CRM Setup',
  marketing: 'Marketing',
  support: 'Support',
  other: 'Overig',
};

const formatRelativeTime = (date: Date) => {
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffHours < 1) return 'zojuist';
  if (diffHours < 24) return `${diffHours} uur geleden`;
  if (diffDays < 7) return `${diffDays} ${diffDays === 1 ? 'dag' : 'dagen'} geleden`;
  return date.toLocaleDateString('nl-NL');
};

const newCount = requests.filter(r => r.status === 'new').length;
---

<DashboardLayout title="Aanvragen">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">Offerte Aanvragen</h1>
        <p class="text-muted-foreground">Binnenkomende aanvragen van klanten</p>
      </div>
      {newCount > 0 && (
        <span class="inline-flex items-center gap-1.5 rounded-full bg-red-100 px-3 py-1 text-sm font-medium text-red-800">
          <span class="h-2 w-2 rounded-full bg-red-500 animate-pulse"></span>
          {newCount} nieuw
        </span>
      )}
    </div>

    <!-- Empty State -->
    {requests.length === 0 && (
      <div class="rounded-xl border bg-card p-12 text-center">
        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-muted">
          <svg class="h-6 w-6 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
          </svg>
        </div>
        <h3 class="mt-4 font-medium">Geen aanvragen</h3>
        <p class="mt-1 text-sm text-muted-foreground">Er zijn momenteel geen openstaande aanvragen.</p>
        <p class="mt-4 text-sm text-muted-foreground">
          Deel je aanvraagformulier: <a href="/aanvraag" class="text-tesoro-500 hover:underline">/aanvraag</a>
        </p>
      </div>
    )}

    <!-- Requests List -->
    {requests.length > 0 && (
      <div class="space-y-4">
        {requests.map((request) => (
          <div class="rounded-xl border bg-card p-6 transition-shadow hover:shadow-md">
            <div class="flex items-start justify-between">
              <div class="flex items-start gap-4">
                <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-muted text-2xl">
                  {typeIcons[request.serviceType] || 'üìù'}
                </div>
                <div>
                  <div class="flex items-center gap-2">
                    <h3 class="font-semibold">{request.companyName || request.contactName}</h3>
                    <span class:list={['inline-flex rounded-full px-2 py-0.5 text-xs font-medium', statusColors[request.status] || 'bg-gray-100 text-gray-800']}>
                      {statusLabels[request.status] || request.status}
                    </span>
                  </div>
                  <p class="text-sm text-muted-foreground">
                    {request.contactName} ¬∑ {typeLabels[request.serviceType] || request.serviceType}
                  </p>
                  <p class="mt-2 text-sm">{request.description}</p>
                  <div class="mt-3 flex items-center gap-4 text-sm text-muted-foreground">
                    {request.budgetIndication && <span>Budget: {request.budgetIndication}</span>}
                    {request.budgetIndication && <span>¬∑</span>}
                    <span>{formatRelativeTime(request.createdAt)}</span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <a
                  href={`/aanvragen/${request.id}`}
                  class="rounded-lg border px-3 py-1.5 text-sm transition-colors hover:bg-muted"
                >
                  Bekijk
                </a>
                <a
                  href={`/offertes/nieuw?request=${request.id}`}
                  class="rounded-lg bg-tesoro-500 px-3 py-1.5 text-sm font-medium text-white transition-colors hover:bg-tesoro-600"
                >
                  Maak Offerte
                </a>
              </div>
            </div>
          </div>
        ))}
      </div>
    )}
  </div>
</DashboardLayout>
